<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>촉각 신경전달 인터랙티브 시뮬레이터</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            padding: 24px;
            background: #f5f5f5;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 32px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background: white;
        }

        .card-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            border: none;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        button:hover {
            background: #f5f5f5;
        }

        button.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2563eb;
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .info-box {
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 12px;
        }

        .info-box.blue {
            background: #e0f2fe;
        }

        .info-box.green {
            background: #d1fae5;
        }

        .info-box.amber {
            background: #fef3c7;
        }

        svg {
            width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .wave-plot, .spike-raster {
            margin-bottom: 20px;
        }

        ul {
            padding-left: 20px;
        }

        ul li {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .value-display {
            font-weight: 600;
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>촉각 신경전달 인터랙티브 시뮬레이터</h1>
        <p class="subtitle">자극 → 수용기(마이이스너/파치니) → ENaC 유사 Na+ 유입 → 수용기 전위 → 발화 → 말초전도(Aβ/Aδ/C) → CNS 도달. *교육용 단순화 모델*</p>

        <div class="grid">
            <div class="card">
                <div class="card-header">입력 & 수용기</div>
                <div class="control-group">
                    <label>수용기 타입</label>
                    <div class="button-group">
                        <button id="btn-meissner" class="active" onclick="setReceptor('Meissner')">Meissner (2–40 Hz)</button>
                        <button id="btn-pacinian" onclick="setReceptor('Pacinian')">Pacinian (40–500 Hz)</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>자극 주파수 (Hz): <span id="freq-val" class="value-display">10</span></label>
                    <input type="range" id="freq-slider" min="1" max="500" value="10" oninput="updateFreq(this.value)">
                </div>
                <div class="control-group">
                    <label>자극 강도 (상대): <span id="amp-val" class="value-display">1.00</span></label>
                    <input type="range" id="amp-slider" min="0" max="2" step="0.01" value="1" oninput="updateAmp(this.value)">
                </div>
                <div class="control-group switch-container">
                    <label>자극 On/Off</label>
                    <label class="switch">
                        <input type="checkbox" id="stim-switch" checked onchange="updateStimOn(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="control-group">
                    <label>시뮬레이션 길이 (ms): <span id="duration-val" class="value-display">500</span></label>
                    <input type="range" id="duration-slider" min="200" max="2000" step="10" value="500" oninput="updateDuration(this.value)">
                </div>
                <div class="control-group">
                    <label>적응 타임상수 τ (ms): <span id="tau-val" class="value-display">120</span></label>
                    <input type="range" id="tau-slider" min="40" max="400" step="5" value="120" oninput="updateTau(this.value)">
                </div>
                <div class="control-group">
                    <label>발화 임계치 θ: <span id="theta-val" class="value-display">0.50</span></label>
                    <input type="range" id="theta-slider" min="0.1" max="1.5" step="0.01" value="0.5" oninput="updateTheta(this.value)">
                </div>
                <div class="control-group">
                    <label>불응기 (ms): <span id="refrac-val" class="value-display">8</span></label>
                    <input type="range" id="refrac-slider" min="2" max="20" value="8" oninput="updateRefrac(this.value)">
                </div>
            </div>

            <div class="card">
                <div class="card-header">축색 전도</div>
                <div class="control-group">
                    <label>섬유 유형</label>
                    <div class="button-group">
                        <button id="btn-ab" class="active" onclick="setFiber('Aβ')">Aβ (50 m/s)</button>
                        <button id="btn-ad" onclick="setFiber('Aδ')">Aδ (15 m/s)</button>
                        <button id="btn-c" onclick="setFiber('C')">C (1.5 m/s)</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>피부→척수 거리 (cm): <span id="distance-val" class="value-display">60</span></label>
                    <input type="range" id="distance-slider" min="10" max="120" value="60" oninput="updateDistance(this.value)">
                </div>
                <div class="info-box blue">
                    <div>전도 지연 ≈ <b id="delay-val">12.0</b> ms</div>
                    <div style="font-size: 12px; opacity: 0.7;">delay = 거리/속도</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">두 점 식별 (공간 분해능)</div>
                <div class="control-group">
                    <label>부위</label>
                    <div class="button-group">
                        <button id="btn-finger" class="active" onclick="setRegion('손가락')">손가락</button>
                        <button id="btn-thumb" onclick="setRegion('엄지')">엄지</button>
                        <button id="btn-palm" onclick="setRegion('손바닥')">손바닥</button>
                        <button id="btn-wrist" onclick="setRegion('손목')">손목</button>
                        <button id="btn-forearm" onclick="setRegion('전완')">전완</button>
                        <button id="btn-upperarm" onclick="setRegion('상완')">상완</button>
                        <button id="btn-shoulder" onclick="setRegion('어깨')">어깨</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>두 점 간격 (mm): <span id="gap-val" class="value-display">3</span></label>
                    <input type="range" id="gap-slider" min="1" max="50" value="3" oninput="updateGap(this.value)">
                </div>
                <div id="perception-box" class="info-box green">
                    <div style="font-size: 18px; font-weight: 600;" id="perception-result">知覺: 두 점</div>
                    <div id="threshold-val">역치(부위별): 2 mm</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">파형 시각화</div>
            <div id="plots"></div>
            <div style="font-size: 12px; opacity: 0.7;">* 위 raster 2개는 각각 피부의 수용체 말단 및 CNS 도달 시점을 나타냅니다.</div>
        </div>

        <div class="card">
            <div class="card-header">설명(요약)</div>
            <ul>
                <li><b>Meissner</b>: 저주파(2–40 Hz)·좁은 수용장·빠른 적응 → 촉각/Flutter.</li>
                <li><b>Pacinian</b>: 고주파(40–500 Hz)·넓은 수용장·빠른 적응 → 진동 감지.</li>
                <li>기계 자극이 ENaC 유사 <b>Na+ 채널</b>을 열어 <b>수용기 전위</b>를 생성(발생기 전위). 임계치 초과 시 활동전위가 발생.</li>
                <li><b>Aβ</b>(촉각) &gt; <b>Aδ</b>(빠른 통증/온도) &gt; <b>C</b>(느린 통증/온도) 순으로 전도속도가 빠릅니다.</li>
                <li>부위별 <b>두 점 식별 역치</b>는 수용장 크기/밀도 차이를 반영합니다(손가락 &lt; 전완 &lt; 어깨).</li>
            </ul>
        </div>
    </div>

    <script>
        // State variables
        let state = {
            receptor: 'Meissner',
            freq: 10,
            amp: 1,
            durationMs: 500,
            theta: 0.5,
            tauMs: 120,
            refracMs: 8,
            fiber: 'Aβ',
            distanceCm: 60,
            stimOn: true,
            region: '손가락',
            pointGap: 3
        };

        const velocities = { 'Aβ': 50, 'Aδ': 15, 'C': 1.5 };
        const twoPointThresholds = {
            '손가락': 2, '엄지': 3, '손바닥': 10, '손목': 20,
            '전완': 35, '상완': 40, '어깨': 45
        };

        const regionButtons = {
            '손가락': 'btn-finger', '엄지': 'btn-thumb', '손바닥': 'btn-palm',
            '손목': 'btn-wrist', '전완': 'btn-forearm', '상완': 'btn-upperarm', '어깨': 'btn-shoulder'
        };

        function bandpassGain(freq, low, high) {
            if (freq <= 0) return 0;
            if (freq < low) return Math.max(0, freq / low);
            if (freq > high) return Math.max(0, high / freq);
            return 1;
        }

        function generateSpikes(time, vrec, theta, refracMs) {
            const spikes = [];
            let lastSpikeT = -Infinity;
            for (let i = 1; i < time.length; i++) {
                const t = time[i];
                if (vrec[i - 1] < theta && vrec[i] >= theta) {
                    if (t - lastSpikeT >= refracMs) {
                        spikes.push(t);
                        lastSpikeT = t;
                    }
                }
            }
            return spikes;
        }

        function simulate() {
            const dt = 1;
            const time = [];
            for (let t = 0; t <= state.durationMs; t += dt) {
                time.push(t);
            }

            const band = state.receptor === 'Meissner' ? { low: 2, high: 40 } : { low: 40, high: 500 };
            const g = bandpassGain(state.freq, band.low, band.high);

            const stim = [];
            const vrec = [];

            for (let i = 0; i < time.length; i++) {
                const t = time[i];
                const s = state.stimOn ? state.amp * Math.sin(2 * Math.PI * (state.freq / 1000) * t) : 0;
                stim.push(s);
                const adapt = Math.exp(-t / state.tauMs);
                vrec.push(s * g * adapt);
            }

            const spikes = generateSpikes(time, vrec, state.theta, state.refracMs);
            const vel = velocities[state.fiber];
            const arrivalDelayMs = (state.distanceCm / 100) / vel * 1000;
            const cnsSpikes = spikes.map(t => t + arrivalDelayMs);

            return { time, stim, vrec, spikes, cnsSpikes, arrivalDelayMs };
        }

        function plotWave(time, y, yLabel, yRange) {
            const width = 600;
            const height = 120;
            const padding = 30;
            const tMin = time[0];
            const tMax = time[time.length - 1];

            const pts = time.map((t, i) => {
                const x = padding + ((t - tMin) / (tMax - tMin)) * (width - padding * 2);
                const yNorm = (y[i] - yRange[0]) / (yRange[1] - yRange[0]);
                const yy = height - padding - yNorm * (height - padding * 2);
                return `${x},${yy}`;
            }).join(' ');

            return `
                <svg viewBox="0 0 ${width} ${height}">
                    <rect x="0" y="0" width="${width}" height="${height}" fill="transparent" stroke="#ccc"/>
                    <line x1="${padding}" x2="${width - padding}" y1="${height / 2}" y2="${height / 2}" stroke="#ddd"/>
                    <polyline points="${pts}" fill="none" stroke="#2563eb" stroke-width="1.5"/>
                    <text x="8" y="16" font-size="12" fill="#666">${yLabel}</text>
                    <text x="${width - 80}" y="16" font-size="12" fill="#666">시간 (ms)</text>
                </svg>
            `;
        }

        function plotSpikes(time, spikes, label) {
            const width = 600;
            const height = 80;
            const padding = 30;
            const tMin = time[0];
            const tMax = time[time.length - 1];

            const lines = spikes.map(t => {
                const x = padding + ((t - tMin) / (tMax - tMin)) * (width - padding * 2);
                return `<line x1="${x}" x2="${x}" y1="10" y2="${height - 10}" stroke="#2563eb" stroke-width="2"/>`;
            }).join('');

            return `
                <svg viewBox="0 0 ${width} ${height}">
                    <rect x="0" y="0" width="${width}" height="${height}" fill="transparent" stroke="#ccc"/>
                    ${lines}
                    <text x="8" y="16" font-size="12" fill="#666">${label}</text>
                    <text x="${width - 80}" y="16" font-size="12" fill="#666">시간 (ms)</text>
                </svg>
            `;
        }

        function render() {
            const result = simulate();

            document.getElementById('delay-val').textContent = result.arrivalDelayMs.toFixed(1);

            const perceivedTwoPoints = state.pointGap >= twoPointThresholds[state.region];
            const perceptionBox = document.getElementById('perception-box');
            perceptionBox.className = perceivedTwoPoints ? 'info-box green' : 'info-box amber';
            document.getElementById('perception-result').textContent = `知覺: ${perceivedTwoPoints ? '두 점' : '한 점'}`;
            document.getElementById('threshold-val').textContent = `역치(부위별): ${twoPointThresholds[state.region]} mm`;

            const plots = document.getElementById('plots');
            plots.innerHTML = `
                <div class="wave-plot">
                    ${plotWave(result.time, result.stim, '기계적 자극', [-state.amp, state.amp])}
                </div>
                <div class="wave-plot">
                    ${plotWave(result.time, result.vrec, '수용기 전위 (RA + 대역통과)', [-state.amp, state.amp])}
                </div>
                <div class="spike-raster">
                    ${plotSpikes(result.time, result.spikes, '발화(raster) - 피부')}
                </div>
                <div class="spike-raster">
                    ${plotSpikes(result.time, result.cnsSpikes, '발화(raster) - CNS 도달')}
                </div>
            `;
        }

        function setReceptor(type) {
            state.receptor = type;
            document.getElementById('btn-meissner').classList.toggle('active', type === 'Meissner');
            document.getElementById('btn-pacinian').classList.toggle('active', type === 'Pacinian');
            render();
        }

        function setFiber(type) {
            state.fiber = type;
            document.getElementById('btn-ab').classList.toggle('active', type === 'Aβ');
            document.getElementById('btn-ad').classList.toggle('active', type === 'Aδ');
            document.getElementById('btn-c').classList.toggle('active', type === 'C');
            render();
        }

        function setRegion(region) {
            state.region = region;
            Object.values(regionButtons).forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            document.getElementById(regionButtons[region]).classList.add('active');
            render();
        }

        function updateFreq(val) {
            state.freq = parseFloat(val);
            document.getElementById('freq-val').textContent = val;
            render();
        }

        function updateAmp(val) {
            state.amp = parseFloat(val);
            document.getElementById('amp-val').textContent = parseFloat(val).toFixed(2);
            render();
        }

        function updateStimOn(checked) {
            state.stimOn = checked;
            render();
        }

        function updateDuration(val) {
            state.durationMs = parseFloat(val);
            document.getElementById('duration-val').textContent = val;
            render();
        }

        function updateTau(val) {
            state.tauMs = parseFloat(val);
            document.getElementById('tau-val').textContent = val;
            render();
        }

        function updateTheta(val) {
            state.theta = parseFloat(val);
            document.getElementById('theta-val').textContent = parseFloat(val).toFixed(2);
            render();
        }

        function updateRefrac(val) {
            state.refracMs = parseFloat(val);
            document.getElementById('refrac-val').textContent = val;
            render();
        }

        function updateDistance(val) {
            state.distanceCm = parseFloat(val);
            document.getElementById('distance-val').textContent = val;
            render();
        }

        function updateGap(val) {
            state.pointGap = parseFloat(val);
            document.getElementById('gap-val').textContent = val;
            render();
        }

        // Initial render
        render();
    </script>
</body>
</html>
